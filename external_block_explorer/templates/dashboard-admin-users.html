<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>Map</title>
	<script defer src="/static/fontawesome_all.js"></script>
	<!-- Compiled and minified JavaScript -->
	<script src="/static/angular.min.js"></script>
	<script src="/static/jquery-3.2.1.min.js"></script>
	<script src="/static/sorter/jquery.tablesorter.js"></script>

	<link rel="stylesheet" href="/static/semantic.min.css" />
	<script src="/static/semantic.min.js"></script>
	<script type="text/javascript" src="/static/toastr.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/toastr.min.css">
</head>

<body ng-app="dashboard" ng-controller='ctrlDashboard'>
	<div class="ui container">
		<br>
		<div class="ui secondary menu">
			<div class="header item">Dashboard</div>
			<a class="active item" href="/dashboard">
				Admin
			</a>
			<a class="item" href="/dashboard/places">
				Places
			</a>
			<a class="item">
				Settings
			</a>
			<a href="/dashboard/places/new" class="blue item"><i class="beer icon"></i>Add a Place</a>
			<div class="right menu">
				<div class="item">
					<div class="ui icon input">
						<input type="text" placeholder="Search...">
						<i class="search link icon"></i>
					</div>
				</div>
				<a class="ui item" ng-click="logout()">
					Logout
				</a>
			</div>
		</div>
		<div class="ui divider"></div>
		<br>
		<div class="ui grid">
			<div class="four wide column">
				<div class="ui secondary vertical pointing fluid menu">
					<a class="item" href="/dashboard/admin">
						Place Details
					</a>
					<a class="item active">
						Users
					</a>
					<a class="item" href="/dashboard/jeeproutes">
						Jeep Routes
					</a>
				</div>
			</div>
			<div class="twelve wide column">
				<h3>Places</h3>
				<table class="ui celled fixed table tablesorter">
					<thead>
						<tr>
							<th>Username</th>
							<th>Name</th>
							<th>Email</th>
							<th>Contact Number</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						<tr ng-repeat="item in details">
							<td>{{item.username}}</td>
							<td>{{item.firstname}} {{item.lastname}}</td>
							<td>{{item.email}}</td>
							<td>{{item.contact_number}}</td>
							<td ng-hide='item.verified'>
								<a ng-click="approve(item.username); item.verified=true;">
									<div class="ui small green button">
										Verify
									</div>
								</a>
							</td>
							<td ng-show='item.verified'>
								<a ng-click="hide(item.username); item.verified=false;">
									<div class="ui small red button">
										Revoke
									</div>
								</a>
							</td>
						</tr>
					</tbody>
					<tfoot></tfoot>
				</table>
			</div>
		</div>
	</div>

	<script type="text/javascript">
		var app = angular.module('dashboard', []);
		app.controller('ctrlDashboard', function ($scope, $http, $timeout, $window) {

			console.log('Requesting Token');
			details = {};
			details.token = localStorage.token;
			request = {
				method: 'POST',
				url: '/api/account/admin/users',
				headers: { 'Content-Type': 'application/json' },
				data: details
			}
			
			$http(request).then(function (response) {
				console.log(response.data);
				data = response.data;
				if (response.data.success) {
					toastr["success"]("Loaded Data!", "Debug");
					$scope.details = response.data.result;
					$timeout(() => {
						$(".tablesorter").tablesorter();
					}, 500);
				} else {
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				}
			}, function () {
				$scope.error = "An unknown error occured!";
			});

			$scope.save = function () {
				$scope.details.token = localStorage.token;
				request = {
					method: 'POST',
					url: '/api/account/update',
					headers: { 'Content-Type': 'application/json' },
					data: $scope.details
				}

				$http(request).then(function (response) {
					console.log(response.data);
					if (response.data.success) {
						$scope.details = response.data.result;
						toastr["success"]("Success", "Saved!")
					} else {
						$scope.error = response.data.result;
						toastr["error"]($scope.error, "Error")
						window.location.href = '/login';
					}
				}, function () {
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				});

			}
			$scope.logout = function () {
				localStorage.token = "";
				window.location.href = '/login';
			}

			$scope.approve = function (id) {
				details = { username: id };
				details.token = localStorage.token;
				details.id = id;
				request = {
					method: 'POST',
					url: '/api/account/admin/approve',
					headers: { 'Content-Type': 'application/json' },
					data: details
				}
				$http(request).then(function (response) {
					console.log(response.data);
				});
			}

			$scope.hide = function (id) {
				details = { username: id };
				details.token = localStorage.token;
				details.id = id;
				request = {
					method: 'POST',
					url: '/api/account/admin/disapprove',
					headers: { 'Content-Type': 'application/json' },
					data: details
				}
				$http(request).then(function (response) {
					console.log(response.data);
				});
			}

		});


	</script>
</body>

</html>