<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>Map</title>
	<script defer src="/static/fontawesome_all.js"></script>
	<!-- Compiled and minified JavaScript -->
	<script src="/static/angular.min.js"></script>
	<script src="/static/jquery-3.2.1.min.js"></script>

	<link rel="stylesheet" href="/static/semantic.min.css" />
	<script src="/static/semantic.min.js"></script>
	<script type="text/javascript" src="/static/toastr.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/toastr.min.css">

	<script src='/static/mapbox-gl.js'></script>
	<link href='/static/mapbox-gl.css' rel='stylesheet' />
	<script src='https://unpkg.com/mapbox@1.0.0-beta10/dist/mapbox-sdk.min.js'></script>

</head>

<body ng-app="dashboard" ng-controller='ctrlDashboard'>
	<div class="ui container">
		<br>
		<div class="ui secondary menu">
			<div class="header item">Dashboard</div>
			<a class="item" href="/dashboard">
				My Account
			</a>
			<a class="item active" href="/dashboard/places">
				Places
			</a>
			<a class="item">
				Settings
			</a>
			<a href="/dashboard/places/new" class="blue item"><i class="beer icon"></i>Add a Place</a></button>
			<div class="right menu">
				<div class="item">
					<div class="ui icon input">
						<input type="text" placeholder="Search...">
						<i class="search link icon"></i>
					</div>
				</div>
				<a class="ui item" ng-click="logout()">
					Logout
				</a>
			</div>
		</div>
		<div class="ui divider"></div>
		<br>
		<div class="ui grid">
			<div class="two wide column">
				<div class="ui secondary vertical pointing fluid menu">
					<a class="item">
						Places
					</a>
					<a class="item active">
						Add new
					</a>
				</div>
			</div>
			<div class="fourteen wide column">
				<div id='map' style='width: auto; height: 400px;'></div>
				<div class="ui segment">
					<form class="ui form">
						<div class="two fields">
							<div class="field disabled input">
								<label>Longitude</label>
								<input type="text" ng-model="data.longitude" name="longitude" placeholder="Longitude">
							</div>
							<div class="field disabled input">
								<label>Latitude</label>
								<input type="text" ng-model="data.latitude" name="Latitude" placeholder="Latitude">
							</div>
						</div>
						<div class="field">
							<label>Name</label>
							<input type="text" ng-model="data.title" name="name" placeholder="My Hispster Resto and Co.">
						</div>
						<div class="two fields">
							<div class="field" ng-class="{disabled: data.address == 'loading'}">
								<label>Address <div class="ui mini inline loader" ng-class="{active: data.address == 'loading'}"></div></label>
								<input type="text" ng-model="data.address" name="address" placeholder="Arguelles, 5000, Iloilo City, Iloilo, Philippines">
							</div>

							<div class="field">
								<label>Contact Number</label>
								<div class="ui right labeled input">
									<label for="amount" class="ui label">+63</label>
									<input placeholder="926..." ng-model="data.contact_number" type="number">
								</div>
							</div>
						</div>

						<div class="ui message" ng-repeat="(menuindex, m) in data.menu">
							<div class="header">
								<h4>Menu Name</h4>
								<div class="ui fluid input">
									<input type="text" placeholder="Menu Name" ng-model="m.name" ng-change="reloadDropdown()">
								</div>
							</div><br>
							<h5>Menu Items</h5>
							<div style="margin: .5rem; padding-left: .5rem; border-left: solid; border-left-color: gray;overflow-x: overlay;max-height: 50vh;">
								<div ng-repeat="item in m.items">
									<div class="ui form" style="margin-bottom: .5rem;">
										<div class="inline fields">
											<div class="ten wide field">
												<label>Item Name</label>
												<input type="text" placeholder="Item Name" ng-model="item.name" ng-change="reloadDropdown()" ng-change="calculateAverage()">
											</div>
											<div class="six wide field">
												<div class="ui right labeled input">
													<label for="amount" class="ui label">PHP</label>
													<input type="text" placeholder="Amount" id="amount" ng-model="item.price" ng-change="calculateAverage()">
													<div class="ui basic label">.00</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<button class="ui primary button" ng-click="newItem(m.name)">
								New Menu Item
							</button>
							<button class="ui secondary button" ng-click="removeItem(m.name)">
								Delete Last Item
							</button>
							<button class="ui red button" ng-click="removeMenu(menuindex)" style="float: right;">
								Remove Menu
							</button>
						</div>
						<div class="ui message">
							<div class="header">
								<h5>New Menu</h5>
								<div class="ui right labeled left icon input">
									<i class="tags icon"></i>
									<input type="text" placeholder="Menu Name" ng-model='newmenu'>
									<a class="ui tag label" ng-click='newMenu()'>
										Add
									</a>
								</div>
							</div>
						</div>
						<div class="ui message">
							<div class="header" style="margin-bottom: 1rem;">
								Specialty
							</div>
							<h4>Menu</h4>
							<div id="specialty-selector" class="ui fluid selection dropdown">
								<input type="hidden" name="menu" ng-model="specialtySelected" ng-change="specialtyChange()">
								<i class="dropdown icon"></i>
								<div class="default text">Menu</div>
								<div class="menu" ng-repeat="(index, m) in data.menu">
									<div class="item" data-value="{{index}}">{{m.name}}</div>
								</div>
							</div>
							<h4>Item</h4>
							<div id="specialty-selector-item" class="ui fluid selection dropdown">
								<input type="hidden" name="menu" ng-model="data.specialty">
								<i class="dropdown icon"></i>
								<div class="default text">Item</div>
								<div class="menu">
								</div>
							</div>
						</div>
						<div class="ui message">
							<h3>Average Budget: {{budgetMin}} to {{budgetMax}} php</h3>
						</div>



						<div class="field">
							<label>Tags (seperate with a comma)</label>
							<input type="text" ng-model="data.tags" name="meal" placeholder="discounts, board games">
						</div>
						<div class="two fields">
							<div class="field">
								<label>Days Open</label>
								<select ng-model="data.days_available" multiple="" class="ui fluid  search selection dropdown days">
									<option ng-repeat="category in days" value="{{category.value}}">{{category.name}}</option>
								</select>
							</div>
							<div class="field">
								<label>Hours</label>
								<input type="text" ng-model="data.hours" name="hours" placeholder="10AM - 10PM">
							</div>
						</div>
						<div class="field">
							<label>Image Link</label>
							<input type="text" ng-model="data.image" name="image" placeholder="10AM - 10PM">
						</div>

						<div class="field">
							<label>Business Permit Image</label>
							<input type="text" ng-model="data.nprops.permit" name="image" placeholder="">
						</div>

						<div class="ui fluid blue submit button" ng-click="addNewPlace()">Submit</div>
					</form>
				</div>
			</div>


		</div>
	</div>

	<script src="/static/style-osm.js"></script>

	<script type="text/javascript">
		$('.ui.rating').rating();
		var app = angular.module('dashboard', []);
		app.controller('ctrlDashboard', function ($scope, $http, $timeout, $window) {
			$scope.data = {}
			mapboxgl.accessToken = 'pk.eyJ1Ijoibm9rdSIsImEiOiJjamZ3a2E1cnMwcmVwMndxZWVwMG50YXV3In0.03gBjH9HrlRWTSoRuw_v8w';
			$scope.mbClient = new MapboxClient(mapboxgl.accessToken);

			/////////////////////////////////// NEW DATA

			$scope.data.menu = [
				{
					name: 'New Menu',
					items: [{ name: 'Champorado', price: 100 }]
				}
			];
			$scope.budget = 100;
			$('#specialty-selector-item').dropdown();
			$('#specialty-selector').dropdown({
				'onChange': function (value, text, choice) {
					console.log(value, text, choice);
					console.log($scope.data.menu[value]);
					values = [];
					for (i = 0; i < $scope.data.menu[value].items.length; i++) {
						values.push({
							value: $scope.data.menu[value].items[i].name,
							text: $scope.data.menu[value].items[i].name,
							name: $scope.data.menu[value].items[i].name
						});
					}
					console.log(values);
					$('#specialty-selector-item').dropdown('setup menu', { values: values });
				}
			});

			$scope.newItem = function (menu) {
				function search(nameKey, myArray) {
					for (var i = 0; i < myArray.length; i++) {
						if (myArray[i].name === nameKey) {
							return myArray[i];
						}
					}
				}
				search(menu, $scope.data.menu).items.push({ name: '', price: 0 });
				console.log($scope.data.menu);
				$scope.reloadDropdown();
			}

			$scope.removeItem = function (menu) {
				function search(nameKey, myArray) {
					for (var i = 0; i < myArray.length; i++) {
						if (myArray[i].name === nameKey) {
							return myArray[i];
						}
					}
				}
				search(menu, $scope.data.menu).items.pop()
			}

			$scope.removeMenu = function (index) {
				$scope.data.menu.pop(index);
			}

			$scope.newMenu = function () {
				$scope.data.menu.push({
					name: $scope.newmenu,
					items: [{ name: '', price: 0 }]
				});
				$scope.reloadDropdown();
			}

			$scope.reloadDropdown = function () {
				values = [];
				for (i = 0; i < $scope.data.menu.length; i++) {
					values.push({
						value: i,
						text: $scope.data.menu[i].name,
						name: $scope.data.menu[i].name
					});
				}
				$('#specialty-selector').dropdown('setup menu', { values: values });
				$scope.calculateAverage();
			}

			$scope.calculateAverage = function () {
				$scope.budgetMin = 1000000000;
				$scope.budgetMax = 0;

				$scope.data.menu.forEach(element => {
					element.items.forEach(item => {
						if (Number(item.price) > $scope.budgetMax) {
							$scope.budgetMax = item.price;
						}
						if (Number(item.price) < $scope.budgetMin) {
							$scope.budgetMin = item.price;
						}
					})
				});
				//console.log(total, count);
				//$scope.averageBudget = Number(total / count).toFixed();

			}
			/////////////////////////////////// NEW DATA

			$scope.map = new mapboxgl.Map({
				container: 'map',
				style: mapStyle,
				center: [122.5564579, 10.7255521],
				maxBounds: [[122.3129, 10.6491], [122.6548, 10.9655]],
				zoom: 14,
				maxZoom: 19,
				minZoom: 8
			});
			$scope.map.on('click', function (e) {
				$scope.data.address = 'loading';
				toastr['success'](JSON.stringify(e.lngLat), "Map Coordinates");
				$scope.data.longitude = e.lngLat.lng;
				$scope.data.latitude = e.lngLat.lat;
				$scope.$apply();
				source = $scope.map.getSource('point')
				if (source) {
					source.setData({
						"type": "Point",
						"coordinates": [e.lngLat.lng, e.lngLat.lat]
					});
				} else {
					$scope.map.addSource('point', {
						"type": "geojson",
						"data": {
							"type": "Point",
							"coordinates": [e.lngLat.lng, e.lngLat.lat]
						}
					});

					$scope.map.addLayer({
						"id": "point",
						"source": "point",
						"type": "circle",
						"paint": {
							"circle-radius": 10,
							"circle-color": "#007cbf"
						}
					});
				}

				$scope.mbClient.geocodeReverse(
					{ latitude: e.lngLat.lat, longitude: e.lngLat.lng },
					function (err, res) {
						console.log(res);
						$scope.data.address = res.features[1].place_name;
						$scope.$apply();
					});

			});

			console.log('Requesting Token');
			request = {
				method: 'POST',
				url: '/api/account/details',
				headers: { 'Content-Type': 'application/json' },
				data: { 'token': localStorage.token },
			}
			$http(request).then(function (response) {
				console.log(response.data);
				if (response.data.success) {
					toastr["success"]("Loaded Data!", "Debug")
					$scope.details = response.data.result;

				} else {
					window.location.href = '/login';
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				}
			}, function () {
				$scope.error = "An unknown error occured!";
			});

			$scope.addNewPlaceDummy = function () {
				console.log($scope.data);
			}

			$scope.addNewPlace = function () {
				$scope.data.token = localStorage.token;
				request = {
					method: 'POST',
					url: '/api/account/place/new',
					headers: { 'Content-Type': 'application/json' },
					data: $scope.data
				}
				$http(request).then(function (response) {
					console.log(response.data);
					if (response.data.success) {
						$scope.details = response.data.result;
						toastr["success"]("Success", "Saved!");
						window.location.href = '/dashboard/places';
					} else {
						$scope.error = response.data.result;
						toastr["error"]($scope.error, "Error")
					}
				}, function () {
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				});

			}
			$scope.logout = function () {
				localStorage.token = "";
				window.location.href = '/login'
			}
		});
	</script>
	<script type="text/javascript">
		angular.element(document).ready(function () {
			$('.ui.dropdown.categories').dropdown();
			$('.ui.dropdown.days').dropdown();

			$(document).ready(function () {
				console.log("Shits loading");
				$('.ui.dropdown.type').dropdown();
				console.log("Shits supposed to be loaded");
			})


		});
	</script>
</body>

</html>