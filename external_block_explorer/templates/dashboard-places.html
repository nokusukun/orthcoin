<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>Map</title>
	<script defer src="/static/fontawesome_all.js"></script>
	<!-- Compiled and minified JavaScript -->
	<script src="/static/angular.min.js"></script>
	<script src="/static/jquery-3.2.1.min.js"></script>

	<link rel="stylesheet" href="/static/semantic.min.css" />
	<script src="/static/semantic.min.js"></script>
	<script type="text/javascript" src="/static/toastr.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/toastr.min.css">
	<script src='/static/mapbox-gl.js'></script>
	<link href='/static/mapbox-gl.css' rel='stylesheet' />
	<style type="text/css">
		#marker {
			background-image: url('/static/gps.png');
			background-size: cover;
			width: 30px;
			height: 30px;
			border-radius: 50%;
			cursor: pointer;
		}
	</style>
</head>

<body ng-app="dashboard" ng-controller='ctrlDashboard'>
	<div class="ui container">
		<br>
		<div class="ui secondary menu">
			<div class="header item">Dashboard</div>
			<a class="item" href="/dashboard">
				My Account
			</a>
			<a class="item active" href="/dashboard/places">
				Places
			</a>
			<a class="item">
				Settings
			</a>
			<a href="/dashboard/places/new" class="blue item"><i class="beer icon"></i>Add a Place</a></button>
			<div class="right menu">
				<div class="item">
					<div class="ui icon input">
						<input type="text" placeholder="Search...">
						<i class="search link icon"></i>
					</div>
				</div>
				<a class="ui item" ng-click="logout()">
					Logout
				</a>
			</div>
		</div>
		<div class="ui divider"></div>
		<br>
		<div class="ui grid">
			<div class="two wide column">
				<div class="ui secondary vertical pointing fluid menu">
					<a class="item active">
						Places
					</a>
					<a class="item">
						Add new
					</a>
				</div>
			</div>
			<div class="fourteen wide column">
				<div id='map' style='width: auto; height: 400px;'></div>
			</div>
			<div class="four wide column" ng-repeat="place in places">
				<div class="ui card" data-html="" style="min-height: 200px">
					<div class="image">
						<img src="{{place.image}}">
					</div>
					<div class="content">
						<div class="header">{{place.title}}</div>
						<div class="description">
							{{place.type}}
							{{place.menu}}
							{{place.categories}}

						</div>
					</div>
					<div class="ui two bottom attached buttons">
						<a class="ui red button" ng-click="delete(item.identifier);">
							<i class="trash alternate icon"></i>
							Delete
						</a>
						<a class="ui primary fluid button" href="/dashboard/places/edit#{{place.identifier}}">
							<i class=" pencil alternate icon"></i>
							Edit
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="/static/style-osm.js"></script>
	<script type="text/javascript">
		$('.ui.rating').rating();
		var app = angular.module('dashboard', []);
		app.controller('ctrlDashboard', function ($scope, $http, $timeout, $window) {
			$scope.map = new mapboxgl.Map({
				container: 'map',
				style: mapStyle,
				center: [122.5564579, 10.7255521],
				maxBounds: [[122.3129, 10.6491], [122.6548, 10.9655]],
				zoom: 14,
				maxZoom: 19,
				minZoom: 8
			});


			console.log('Requesting Token');
			request = {
				method: 'POST',
				url: '/api/account/place/my',
				headers: { 'Content-Type': 'application/json' },
				data: { 'token': localStorage.token },
			}
			$http(request).then(function (response) {
				console.log(response.data);
				if (response.data.success) {
					toastr["success"]("Loaded Data!", "Debug")
					console.log(response.data);
					$scope.places = response.data.result;
					$scope.places.forEach(function (data, index) {
						console.log(data);
						popup = new mapboxgl.Popup()
							.setHTML(`<h5>${data.title}</h5></br><p>${data.address}<p>`);
						// create DOM element for the marker
						el = document.createElement('div');
						el.id = "marker";

						// create the marker
						new mapboxgl.Marker(el)
							.setLngLat([data.longitude, data.latitude])
							.setPopup(popup) // sets a popup on this marker
							.addTo($scope.map);
					});
				} else {
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				}
			}, function () {
				$scope.error = "An unknown error occured!";
			});

			$scope.delete = function (id) {
				details = {};
				details.token = localStorage.token;
				details.id = id;
				request = {
					method: 'POST',
					url: '/api/account/place/delete',
					headers: { 'Content-Type': 'application/json' },
					data: details
				}
				$http(request).then(function (response) {
					console.log(response.data);
				});
			}

			$scope.logout = function () {
				localStorage.token = "";
				window.location.href = '/login';
			}
		});


	</script>

</body>

</html>