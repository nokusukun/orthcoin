<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- Site Properties -->
	<title>Search</title>
	<script defer src="/static/fontawesome_all.js"></script>
	<!-- Compiled and minified JavaScript -->
	<script src="/static/angular.min.js"></script>
	<script src="/static/jquery-3.2.1.min.js"></script>

	<link rel="stylesheet" href="/static/semantic.min.css"/>
	<script src="/static/semantic.min.js"></script>
	<script type="text/javascript" src="/static/toastr.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/toastr.min.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<script src='/static/mapbox-gl.js'></script>
	<link href='/static/mapbox-gl.css' rel='stylesheet' />

	<style type="text/css">
	#main-container {
		min-height: 100vh;
	}
	.scrollable {
		overflow: scroll;
		overflow-x: hidden;
		max-height: 90vh;
	}
	</style>
	<style type="text/css">

	.hidden.menu {
		display: none;
	}

	.masthead.segment {
		min-height: 700px;
		padding: 1em 0em;
	}
	.masthead .logo.item img {
		margin-right: 1em;
	}
	.masthead .ui.menu .ui.button {
		margin-left: 0.5em;
	}
	.masthead h1.ui.header {
		margin-top: 3em;
		margin-bottom: 0em;
		font-size: 4em;
		font-weight: normal;
	}
	.masthead h2 {
		font-size: 1.7em;
		font-weight: normal;
	}

	.ui.vertical.stripe {
		padding: 8em 0em;
	}
	.ui.vertical.stripe h3 {
		font-size: 2em;
	}
	.ui.vertical.stripe .button + h3,
	.ui.vertical.stripe p + h3 {
		margin-top: 3em;
	}
	.ui.vertical.stripe .floated.image {
		clear: both;
	}
	.ui.vertical.stripe p {
		font-size: 1.33em;
	}
	.ui.vertical.stripe .horizontal.divider {
		margin: 3em 0em;
	}

	.quote.stripe.segment {
		padding: 0em;
	}
	.quote.stripe.segment .grid .column {
		padding-top: 5em;
		padding-bottom: 5em;
	}

	.footer.segment {
		padding: 5em 0em;
	}

	.secondary.pointing.menu .toc.item {
		display: none;
	}

	@media only screen and (max-width: 700px) {
		.ui.fixed.menu {
			display: none !important;
		}
		.secondary.pointing.menu .item,
		.secondary.pointing.menu .menu {
			display: none;
		}
		.secondary.pointing.menu .toc.item {
			display: block;
		}
		.masthead.segment {
			min-height: 350px;
		}
		.masthead h1.ui.header {
			font-size: 2em;
			margin-top: 1.5em;
		}
		.masthead h2 {
			margin-top: 0.5em;
			font-size: 1.5em;
		}
	}
	.blurry-map{
		background: url("/static/background.png") !important;
		background: cover !important;
	}

	#marker {
		background-image: url('/static/gps.png');
		background-size: cover;
		width: 30px;
		height: 30px;
		border-radius: 50%;
		cursor: pointer;
	}
</style>
<script>
	$(document)
	.ready(function() {

      // fix menu when passed
      $('.masthead')
      .visibility({
      	once: false,
      	onBottomPassed: function() {
      		$('.fixed.menu').transition('fade in');
      	},
      	onBottomPassedReverse: function() {
      		$('.fixed.menu').transition('fade out');
      	}
      })
      ;

      // create sidebar and attach to menu open
      $('.ui.sidebar')
      .sidebar('attach events', '.toc.item')
      ;

  })
	;
</script>
</head>
<body ng-app="search" ng-controller="ctrlSearch" id="search-body">

	<div class="ui modal search">
		<i class="close icon"></i>
		<div class="header">
			Search For A Place
		</div>
		<div class="content">
			<div class="ui action fluid input">
				<input type="text" value="" ng-model="searchTerms" ng-change="search(searchTerms)" placeholder="Search for a name">
			</div>
			
			<table class="ui basic table">
				<thead>
					<tr>
						<th>Name</th>
						<th>Rating</th>
						<th>Address</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					<tr ng-repeat="item in results | limitTo:5">
						<td>{{item.place.title}}</td>
						<td>{{item.place.upvotes}}</td>
						<td>{{item.place.address}}</td>
						<td><button class="ui button" ng-click="findRoute(item.place.longitude, item.place.latitude);$('.ui.modal.search').modal('hide');">Find Route</button></td>

					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<div class="ui modal customhost">
		<i class="close icon"></i>
		<div class="header">
			Custom Host
		</div>
		<div class="content">
			<div class="ui action fluid input">
				<input type="text" value="" ng-model="host" placeholder="[Debug] Custom Host" ng-change="reloadMarkers()">
			</div>
			
		</div>
	</div>

	<!-- Page Contents -->
	<div class="pusher">
		<div class="ui text" style="height: 15vh; width: 100vw; padding: 3rem; padding-top: 4vh; position: absolute; top: 0; z-index: 1">
			<div class="ui">
				<div class="ui form">
					<div class="two fields">
						<div class="field">
							<button class="ui teal button" onclick="$('.ui.modal.search').modal('show');">
								Search
							</button>

							<button ng-click="selectLocation()" class="ui teal button">
								<i class="crosshairs icon"></i>
								{{locationText}}
							</button>
							<button class="ui icon blue button" onclick="$('.ui.modal.customhost').modal('show');">
								<i class="cloud icon"></i>
							</button>
							<button ng-click="clearMarkers()"  class="ui blue button">
								Clear Markers
							</button>
							<div class="ui floating labeled icon dropdown button">
								<i class="car icon"></i>
								<span class="text">Display Jeep Routes</span>
								<div class="menu">
									<div class="item blue" ng-click="displayJeep(item)" ng-repeat="item in jeeproutes">
										<i class="tags icon jproute-en-{{item.id}}" ng-show="item.enabled"></i>
										{{item.name}}
									</div>
								</div>
							</div>
							<button class="ui button" ng-click="autofind()">
								Auto Find
							</button>
							<button class="ui button" ng-click="clear()">
								Remove Routes
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id='map' style='width: auto; height: 100vh;'></div>
	</div>

</body>
<script src="/static/style-osm.js"></script>
<script type="text/javascript">
	var app = angular.module('search', []);
	app.controller('ctrlSearch', function($scope, $http, $timeout, $window, $compile) {
		mapboxgl.accessToken = 'pk.eyJ1Ijoibm9rdSIsImEiOiJjamZ3a2E1cnMwcmVwMndxZWVwMG50YXV3In0.03gBjH9HrlRWTSoRuw_v8w';
		//bounds = L.lngLatBounds(L.lngLat(122.3129,10.6491), L.lngLat(122.6548,10.9655));
		markers = [];
		jeepMarkers = {};
		$scope.host = "";
		$scope.map = new mapboxgl.Map({
			container: 'map',
			style: mapStyle,
			center: [122.5564579,10.7255521],
			maxBounds: [[122.3129,10.6491], [122.6548,10.9655]],
			zoom: 14,
			maxZoom: 19,
			minZoom: 8
		});
		$scope.locationText = "";


		console.log('Requesting Token');
		request = {
			method: 'GET',
			url: $scope.host + '/api/account/place/all',
			headers: {'Content-Type': 'application/json'}
		}
		$http(request).then(function(response){
			console.log(response.data);
			if(response.data.success){
				toastr["success"]("Loaded Data!", "Debug")
				console.log(response.data);
				$scope.places = response.data.result;
				$scope.places.forEach(function (data, index) {
					console.log(data);
					if(data.approved){
						htmlData = $compile(
							`<h5>${data.title}</h5>
							<p>${data.address}<p>
							<p>${data.contact_number}</p>
							<p>
							<b><span id="span-upvotecount-${data.identifier}">${data.upvotes}</span> upvotes</b><br />
							<span><b>Specialty:</b> ${data.specialty}</span>
							</p>
							<button class='ui button' onclick='JSfindRoute(${data.longitude}, ${data.latitude})'>
							Find Route
							</button>
							<button class='ui button' onclick='JSjeepRoute(${data.longitude}, ${data.latitude})'>
							Find Jeep
							</button>
							<button class='ui button' id="btn-upvote-${data.identifier}" onclick='JSupvote("${data.identifier}")'>
							Upvote!
							</button>`)($scope)
							htmlCarrier = document.createElement("div");
							htmlCarrier.setAttribute("id", "container-place-"+data.identifier);
							angular.element(htmlCarrier).append(htmlData);
							popup = new mapboxgl.Popup().setHTML(htmlCarrier.outerHTML);
						// create DOM element for the marker
						el = document.createElement('div');
						el.id = "marker";
						// create the marker
						new mapboxgl.Marker(el)
						.setLngLat([data.longitude, data.latitude])
						    .setPopup(popup) // sets a popup on this marker
						    .addTo($scope.map);
						    markers.push(marker);
						}

					});
			}else{
				$scope.error = response.data.result;
				toastr["error"]($scope.error, "Error")
			}
		}, function(){
			$scope.error = "An unknown error occured!";
		});

		request = {
			method: 'GET',
			url: $scope.host + '/api/account/jeeproutes/all',
			headers: {'Content-Type': 'application/json'}
		}
		$http(request).then(function(response){
			console.log(response.data);
			$scope.jeeproutes = response.data.result;
			$timeout(function() {
				$('.ui.dropdown').dropdown();
			}, 500);
		});

		$scope.clearMarkers = function () {
			while(markers.length > 0){
				markers.pop().remove();
			}
		}

		$scope.reloadMarkers = function() {
			$scope.clearMarkers()
			request = {
				method: 'GET',
				url: $scope.host + '/api/account/place/all',
				headers: {'Content-Type': 'application/json'}
			}
			$http(request).then(function(response){
				console.log(response.data);
				if(response.data.success){
					toastr["success"]("Loaded Data!", "Debug")
					console.log(response.data);
					$scope.places = response.data.result;
					$scope.places.forEach(function (data, index) {
						console.log(data);
						if(data.approved){
							htmlData = $compile(
								`<h5>${data.title}</h5>
								<p>${data.address}<p>
								<p>${data.contact_number}</p>
								<p>
								<b><span id="span-upvotecount-${data.identifier}">${data.upvotes}</span> upvotes</b><br />
								<span><b>Specialty:</b> ${data.specialty}</span>
								</p>
								<button class='ui button' onclick='JSfindRoute(${data.longitude}, ${data.latitude})'>
								Find Route
								</button>
								<button class='ui button' id="btn-upvote-${data.identifier}" onclick='JSupvote("${data.identifier}")'>
								Upvote!
								</button>`)($scope)
								htmlCarrier = document.createElement("div");
								htmlCarrier.setAttribute("id", "container-place-"+data.identifier);
								angular.element(htmlCarrier).append(htmlData);
								popup = new mapboxgl.Popup().setHTML(htmlCarrier.outerHTML);
						// create DOM element for the marker
						el = document.createElement('div');
						el.id = "marker";
						// create the marker
						marker = new mapboxgl.Marker(el)
						.setLngLat([data.longitude, data.latitude])
						    .setPopup(popup) // sets a popup on this marker
						    .addTo($scope.map);
						    markers.push(marker);
						}

					});
				}else{
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				}
			}, function(){
				$scope.error = "An unknown error occured!";
			});

		}

		$scope.upvote = function(identifier) {
			request = {
				method: 'POST',
				url: $scope.host + '/api/account/place/upvote',
				headers: {'Content-Type': 'application/json'},
				data: {"id": identifier}
			}
			$http(request).then(function(response){
				console.log(response.data);
				if(response.data.success){
					toastr["success"]("Success", "You upvoted this place!");
					console.log(response.data.result.identifier);
					$("#span-upvotecount-"+response.data.result.identifier).text(response.data.result.upvotes);
				}else{
					$scope.error = response.data.result;
					toastr["error"]($scope.error, "Error")
				}
			}, function(){
				$scope.error = response.data.result;
				toastr["error"]($scope.error, "Error")
			});
		}

		$scope.findRoute = function(long, lat) {
			$scope.status = "Looking up route";
			if($scope.currentLongitude != null){
				try{
					$scope.map.removeLayer("route");
					$scope.map.removeSource("route");
				}catch (e){}
				$http.get($scope.host + `/api/route?start=${$scope.currentLatitude},${$scope.currentLongitude}&destination=${lat},${long}`).then( 
					function (response){
						console.log(response.data);
						$scope.destination_lat = lat;
						$scope.destination_lon = long;
						$scope.map.addLayer({
							id: 'route',
							type: 'line',
							layout: {'line-cap': 'round', 
							'line-join': 'bevel'},
							source:{
								type: 'geojson',
								data: response.data},
								paint: {
									"line-color": "#11ff11",
									"line-width": 4
								}
							});
					});
			}else{
				toastr["error"]("Please set a location!", "Error!")
			}
			$scope.status = "Done.";
		}

		$scope.findjeepRoute = function (long, lat) {
			$scope.destination_lat = lat;
			$scope.destination_lon = long;
			$scope.autofind();
		}

		$scope.autofind = function(){
			function search(nameKey, myArray){
				for (var i=0; i < myArray.length; i++) {
					if (myArray[i].id === nameKey) {
						return myArray[i];
					}
				}
			}
			from = [$scope.currentLatitude, $scope.currentLongitude];
			to = [$scope.destination_lat, $scope.destination_lon];
			
			$http.get(`/api/jeep/find/${from[0]}/${from[1]}/${to[0]}/${to[1]}`).then(
				function(response){
					console.log(response);
					//$scope.displayJeep({
					//	id: response.data.result.source,
					//	enabled: false});
					//$scope.displayJeep({
					//	id: response.data.result.destination,
					//	enabled: false});
					source = response.data.result.source;
					destination = response.data.result.destination;
					console.log($scope.jeeproutes)
					x_source = search(source, $scope.jeeproutes)
					x_dest = search(destination, $scope.jeeproutes)
					$scope.displayJeep(x_source);
					if(x_source != x_dest){
						$timeout(function(){
							$scope.displayJeep(x_dest);
						}, 400);
					}

					try{
						jeepMarkers.source.remove();
						jeepMarkers.destination.remove();
					}catch (e){}
					
					
					jeepMarkers.source = new mapboxgl.Popup({closeOnClick: false})
						.setLngLat({lng: from[1], lat: from[0]})
						.setHTML(`<h5>Enter: ${x_source.name}</h5>`)
						.addTo($scope.map);

					jeepMarkers.destination = new mapboxgl.Popup({closeOnClick: false})
						.setLngLat({lng: to[1], lat: to[0]})
						.setHTML(`<h5>Exit: ${x_dest.name}</h5>`)
						.addTo($scope.map);
					
				}
			)
		}

		$scope.displayJeep = function(route){
			function getRandomColor() {
				var letters = '0123456789ABCDEF';
				var color = '#';
				for (var i = 0; i < 6; i++) {
					color += letters[Math.floor(Math.random() * 16)];
				}
				return color;
			}
			route_name = route.id;
			if(route.enabled){
				route.enabled = "";
				try{
					$scope.map.removeLayer("route_jeep_"+route_name);
				}catch (e){}
				try{
					$scope.map.removeSource("route_jeep_"+route_name);
				}catch (e){}
			}else{
				console.log("Setting Source: "+route_name);
				color = getRandomColor();
				route.enabled = "✅";
				$http.get(`/api/jeep/${route_name}.geojson`).then( 
					function (response){
						console.log(response.data);
						$scope.map.addLayer({
							id: 'route_jeep_'+route_name,
							type: 'line',
							layout: {'line-cap': 'round', 
							'line-join': 'bevel'},
							source:{
								type: 'geojson',
								data: response.data},
								paint: {
									"line-color": color,
									"line-width": 4,
									"line-dasharray": [0, 4, 3]
								}
							});
						
						//coords = response.data.features[0].geometry.coordinates;
						//console.log(coords);
						//center = coords[Number(Number(coords.length / 2).toFixed())];
						
						
						

						try {
							$scope.map.moveLayer('route');
						}catch (e) {}
					});
				$timeout(function() {
					$(".jproute-en-"+route_name).css("color", color);
				}, 400);
			}

		}

		$scope.selectLocation = function (){
			$scope.locationText = "Click on an area on the map";
			$scope.selectPointMode = true;
		}

		$scope.clear = function() {
			try{
				$scope.map.removeLayer("route_jeep");
				$scope.map.removeSource("route_jeep");
			}catch (e){}
			try{
				$scope.map.removeLayer("route");
				$scope.map.removeSource("route");
			}catch (e){}
		}

		$scope.search = function (search_term) {
			searchTerms = function(object, stuff){
				score = 0;
				_object = JSON.stringify(object).toLowerCase();
				stuff.forEach(function (x) {
					if(x.length	> 2){
						if(_object.search(x) > -1){
							score = score + 1;
						}
					}
					
				})
				return score
			}

			$scope.results = [];
			places_sorted = $scope.places;
			places_sorted.sort(function(a,b) {return (a.upvotes < b.upvotes) ? 1 : ((b.upvotes < a.upvotes) ? -1 : 0);} );
			places_sorted.forEach(function(place){
				score = searchTerms(place, search_term.toLowerCase().split(" "));
				if(score > 0 ){
					$scope.results.push({
						"score": score,
						"place": place
					});
				}
			})
		}

		$scope.map.on('click', function (e) {
			if($scope.selectPointMode){
				toastr['success'](JSON.stringify(e.lngLat), "Map Coordinates");
				console.log(e);
				$scope.currentLongitude = e.lngLat.lng;
				$scope.currentLatitude = e.lngLat.lat;
				$scope.$apply();
				source = $scope.map.getSource('point')
				if(source){
					source.setData( {"type": "Point",
						"coordinates": [e.lngLat.lng, e.lngLat.lat]});
				}else{
					$scope.map.addSource('point', {
						"type": "geojson",
						"data": {"type": "Point",
						"coordinates": [e.lngLat.lng, e.lngLat.lat]}
					});

					$scope.map.addLayer({
						"id": "point",
						"source": "point",
						"type": "circle",
						"paint": {
							"circle-radius": 10,
							"circle-color": "#007cbf"
						}
					});
				}
				$scope.selectPointMode = false;
				$scope.locationText = "";
				$scope.$apply();
			}else{
				$scope.locationText = ""
			}

		});

	});
</script>
<script type="text/javascript">
	JSfindRoute = function (long, lat){
		angular.element(document.getElementById("search-body")).scope().findRoute(long, lat);
	}
	JSjeepRoute = function (long, lat){
		angular.element(document.getElementById("search-body")).scope().findjeepRoute(long, lat);
	}
	JSupvote = function (identifier){
		angular.element(document.getElementById("search-body")).scope().upvote(identifier);
	}
	$('.ui.dropdown')
	.dropdown()
	;
</script>
</html>

</html>